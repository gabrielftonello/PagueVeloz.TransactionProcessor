services:
  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: pv-sqlserver
    restart: unless-stopped
    environment:
      ACCEPT_EULA: "Y"
      MSSQL_SA_PASSWORD: "Your_password123"
      MSSQL_PID: "Express"
    ports:
      - "1433:1433"
    volumes:
      - sqlserver-data:/var/opt/mssql
    healthcheck:
      test: ["CMD-SHELL", "(/opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P $$MSSQL_SA_PASSWORD -Q 'SELECT 1' -C || /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P $$MSSQL_SA_PASSWORD -Q 'SELECT 1' -C) >/dev/null || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 20

  rabbitmq:
    image: rabbitmq:3-management
    container_name: pv-rabbitmq
    restart: unless-stopped
    environment:
      RABBITMQ_DEFAULT_USER: "pv"
      RABBITMQ_DEFAULT_PASS: "pvpass"
      RABBITMQ_DEFAULT_VHOST: "/"
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    healthcheck:
      test: ["CMD-SHELL", "rabbitmq-diagnostics -q ping"]
      interval: 10s
      timeout: 5s
      retries: 20

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.12.2
    container_name: pv-elasticsearch
    restart: unless-stopped
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - ES_JAVA_OPTS=-Xms512m -Xmx512m
    ports:
      - "9200:9200"
    volumes:
      - esdata:/usr/share/elasticsearch/data
    healthcheck:
      test: ["CMD-SHELL", "curl -s http://localhost:9200 >/dev/null || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 30

  kibana:
    image: docker.elastic.co/kibana/kibana:8.12.2
    container_name: pv-kibana
    restart: unless-stopped
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
      - xpack.security.enabled=false
    ports:
      - "5601:5601"
    depends_on:
      elasticsearch:
        condition: service_healthy

  kibana-setup:
    image: alpine:3.20
    container_name: pv-kibana-setup
    restart: "no"
    depends_on:
      kibana:
        condition: service_started
      elasticsearch:
        condition: service_healthy
    volumes:
      - ./docker/kibana:/bootstrap:ro
    environment:
      KIBANA_URL: "http://kibana:5601"
      SAVED_OBJECTS_FILE: "/bootstrap/pv_saved_objects.ndjson"
    entrypoint: ["/bin/sh", "/bootstrap/bootstrap.sh"]

  apm-server:
    image: docker.elastic.co/apm/apm-server:8.12.2
    container_name: pv-apm-server
    restart: unless-stopped
    depends_on:
      elasticsearch:
        condition: service_healthy
      kibana:
        condition: service_started
    ports:
      - "8200:8200"
    command: [
      "apm-server",
      "-e",
      "-E", "apm-server.host=0.0.0.0:8200",
      "-E", "output.elasticsearch.hosts=[http://elasticsearch:9200]",
      "-E", "setup.kibana.host=http://kibana:5601",
      "-E", "xpack.security.enabled=false"
    ]

  filebeat:
    image: docker.elastic.co/beats/filebeat:8.12.2
    container_name: pv-filebeat
    user: root
    restart: unless-stopped
    depends_on:
      elasticsearch:
        condition: service_healthy
    volumes:
      - ./docker/filebeat.yml:/usr/share/filebeat/filebeat.yml:ro
      - pv-logs:/var/log/pv:ro
    command: ["--strict.perms=false"]

  api:
    build:
      context: .
      dockerfile: src/PagueVeloz.TransactionProcessor.Api/Dockerfile
    container_name: pv-api
    restart: unless-stopped
    labels:
      co.elastic.logs/enabled: "true"
    ports:
      - "5000:5000"
    volumes:
      - pv-logs:/var/log/pv
    environment:
      ASPNETCORE_ENVIRONMENT: "Development"
      ASPNETCORE_URLS: "http://+:5000"
      ConnectionStrings__SqlServer: "Server=sqlserver,1433;Database=pagueveloz;User Id=sa;Password=Your_password123;TrustServerCertificate=True;Encrypt=False"
      RabbitMq__Host: "rabbitmq"
      RabbitMq__Port: "5672"
      RabbitMq__Username: "pv"
      RabbitMq__Password: "pvpass"
      RabbitMq__VirtualHost: "/"
      RabbitMq__Exchange: "tx.events"
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://apm-server:8200"
      OTEL_EXPORTER_OTLP_PROTOCOL: "http/protobuf"
      Logging__FilePath: "/var/log/pv/api.log"
    depends_on:
      sqlserver:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy

  worker:
    build:
      context: .
      dockerfile: src/PagueVeloz.TransactionProcessor.Worker/Dockerfile
    container_name: pv-worker
    restart: unless-stopped
    labels:
      co.elastic.logs/enabled: "true"
    volumes:
      - pv-logs:/var/log/pv
    environment:
      ConnectionStrings__SqlServer: "Server=sqlserver,1433;Database=pagueveloz;User Id=sa;Password=Your_password123;TrustServerCertificate=True;Encrypt=False"
      RabbitMq__Host: "rabbitmq"
      RabbitMq__Port: "5672"
      RabbitMq__Username: "pv"
      RabbitMq__Password: "pvpass"
      RabbitMq__VirtualHost: "/"
      RabbitMq__Exchange: "tx.events"
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://apm-server:8200"
      OTEL_EXPORTER_OTLP_PROTOCOL: "http/protobuf"
      Logging__FilePath: "/var/log/pv/worker.log"
      Outbox__BatchSize: "50"
    depends_on:
      sqlserver:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      api:
        condition: service_started

  consumer:
    build:
      context: .
      dockerfile: src/PagueVeloz.TransactionProcessor.EventConsumer/Dockerfile
    container_name: pv-consumer
    restart: unless-stopped
    labels:
      co.elastic.logs/enabled: "true"
    volumes:
      - pv-logs:/var/log/pv
    environment:
      RabbitMq__Host: "rabbitmq"
      RabbitMq__Port: "5672"
      RabbitMq__Username: "pv"
      RabbitMq__Password: "pvpass"
      RabbitMq__VirtualHost: "/"
      RabbitMq__Exchange: "tx.events"
      RabbitMq__Queue: "tx.events.audit"
      RabbitMq__BindingKey: "#"
      Elasticsearch__Url: "http://elasticsearch:9200"
      Logging__FilePath: "/var/log/pv/consumer.log"
    depends_on:
      rabbitmq:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy

volumes:
  pv-logs:
  esdata:
  sqlserver-data:
  rabbitmq-data:
